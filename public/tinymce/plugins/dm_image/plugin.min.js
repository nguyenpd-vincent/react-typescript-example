// Adds a custom plugin to the editor.
tinymce.PluginManager.add('dm_image', function(editor) {
	var input = document.createElement('input');
	input.setAttribute('type', 'file');
	input.addEventListener('change', function(e) {
		var files = this.files;
		if (files) {
			
			// Pour chaque image selectionnée, on encode en base64.
			for(var i = 0, len = files.length; i < len; i++) {
				var file = files[i];
				if (/(png|jpeg|jpg|gif)$/.test(file.type)) {
					resizeAndPushImage(file);
				}
			}
			
		}
	});
	
	/**
	 * Redimenssionement de l'image puis insertion dans le courrier.
	 * 
	 * @param {File} file Fichier à redimenssionner.
	 */
	function resizeAndPushImage(file) {
		var reader = new FileReader();
		reader.onloadend = function(e) {
			var image = new Image();
			image.src = e.target.result;
			image.onload = function() {
				var maxWidth = 700;
				var maxHeight = 700;
				var imageWidth = image.width;
				var imageHeight = image.height;
				
				// Redimenssionement de l'image en fonction de la largeur et hauteur max.
				if (imageWidth > imageHeight) {
					if (imageWidth > maxWidth) {
						imageHeight *= maxWidth / imageWidth;
						imageWidth = maxWidth;
					}
				} else {
					if (imageHeight > maxHeight) {
						imageWidth *= maxHeight / imageHeight;
						imageHeight = maxHeight;
					}
				}
				
				// Regénération de l'image.
				var canvas = document.createElement("canvas");
				canvas.width = imageWidth;
				canvas.height = imageHeight;
				image.width = imageWidth;
				image.height = imageHeight;
				var ctx = canvas.getContext("2d");
				ctx.drawImage(this, 0, 0, imageWidth, imageHeight);
				
				// Insertion de l'image.
				editor.execCommand('mceInsertContent', false, '<img src="' + canvas.toDataURL(file.type) + '" width="' + imageWidth + '" height="' + imageHeight + '" />');
			}
		}
		
		reader.readAsDataURL(file);
	}
	
    // Command
	editor.addCommand('dm_image', function() {
        input.click();
	});
	
    // Menuitem
	editor.addMenuItem('dm_image', {
		type: 'menuitem',
		text: 'Image',
		icon: 'image',
		context: 'insert',
        cmd: 'dm_image'
	});
});